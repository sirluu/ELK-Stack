# vi logstash/pipeline/message.yml
input {
  beats {
    port => 5000
  }
  stdin {
	codec => multiline {
        pattern => "^%{TIMESTAMP_ISO8601}"
        negate => true
        what => "previous"
	}
  }
}
filter {
	if [fields][document_type] == "cdr-mobiagri" {
		grok {
			match => {"message" => "%{NUMBER:MSISDN}\,%{NUMBER:SERVICE_CODE}\,%{WORD:GROUP_CODE}\,%{WORD:PACKAGE_CODE}\,%{DATA:REG_DATETIME}\,%{DATA:START_DATETIME}\,%{DATA:END_DATETIME}\,%{DATA:EXPIRE_DATETIME}\,%{NUMBER:STATUS}\,%{WORD:CHANNEL}\,%{DATA:COMMAND}\,%{NUMBER:CHARGE_PRICE}\,%{DATA:MT}\,%{WORD:MO}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "bigdata-sync" {
        grok {
            match => {
                "message" => "%{NOTSPACE:a} %{NOTSPACE:b} %{LOGLEVEL:loglevel} %{NOTSPACE:c} %{GREEDYDATA:log_content}"
            }
        }
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "bigdata-api" {
        grok {
            match => {
                "message" => "%{DATESTAMP:DATE_BIG} %{GREEDYDATA:USER_BIG}\|%{GREEDYDATA:API_BIG}\|%{NUMBER:TIME_RESPONSE}"
            }
        }
	}
	if [fields][document_type] == "vietplant-ai" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "vietplant-api" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "vietplant-job" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "vietplant-onesignal" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "vietplant-time" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "vietplant-vas" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "vietplant-lumen" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-lumen" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-time" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-job" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-onesignal" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-ai" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-api" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
        mutate { gsub => [ "log_content", "\n", "" ] }
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
			mutate {
				remove_field => [ "RESPONSE.result.GMOS*" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-api-kcn" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
        mutate { gsub => [ "log_content", "\n", "" ] }
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
			mutate {
				remove_field => [ "RESPONSE.result.GMOS*" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-vas" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "ai-ai" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "ai-lumen" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}: %{GREEDYDATA:log_content}"}
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
	if [fields][document_type] == "mobiagri-error" {
		grok {
			match => {"message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:env}\.%{DATA:severity}:%{SPACE}(?<err_content>(.|\r|\n|)*)"}
		}
		date {
		  match => ["timestamp", "YYYY-MM-dd HH:mm:ss"]
		  target => "@timestamp"
		}
		mutate { gsub => [ "err_content", "\n", "" ] }
		json {
			source => "err_content"
		}
	}
    if [fields][document_type] == "charge-smsbn" {
		grok {
			match => {"message" => "%{TIMESTAMP_ISO8601:date_time} \[%{DATA:thread_id}\] %{LOGLEVEL:level_log} %{DATA:java_class} - %{GREEDYDATA:log_content}"}
		}
        mutate { gsub => [ "log_content", "\n", "" ] }
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
    if [fields][document_type] == "charge-csp" {
		grok {
			match => {"message" => "%{TIMESTAMP_ISO8601:date_time} \[%{DATA:thread_id}\] %{LOGLEVEL:level_log} %{DATA:java_class} - %{GREEDYDATA:log_content}"}
		}
        mutate { gsub => [ "log_content", "\n", "" ] }
		json {
			source => "log_content"
		}
		if "_grokparsefailure" in [tags] {
			mutate {
				remove_tag => ["_grokparsefailure"]
			}
		} else {
			mutate {
				remove_field => [ "log_content" ]
			}
			mutate {
				remove_field => [ "message" ]
			}
		}
	}
}
output {
  if [fields][document_type] == "cdr-mobiagri" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "cdr-mobiagri"
	  codec => json
    }
  }
  if [fields][document_type] == "ai-ai" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "ai-ai"
	  codec => json
    }
  }
  if [fields][document_type] == "ai-lumen" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "ai-lumen"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-ai" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-ai"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-api" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-api"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-job" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-job"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-onesignal" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-onesignal"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-time" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-time"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-vas" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-vas"
	  codec => json
    }
  }
  if [fields][document_type] == "vietplant-lumen" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "vietplant-lumen"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-ai" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-ai"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-api" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-api"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-api-kcn" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-api-kcn"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-job" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-job"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-onesignal" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-onesignal"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-time" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-time"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-vas" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-vas"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-lumen" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-lumen"
	  codec => json
    }
  }
  if [fields][document_type] == "bigdata-sync" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "bigdata-sync"
	  codec => json
    }
  }
  if [fields][document_type] == "bigdata-api" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "bigdata-api"
	  codec => json
    }
  }
  if [fields][document_type] == "mobiagri-error" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "mobiagri-error"
	  codec => json
    }
  }
  if [fields][document_type] == "charge-smsbn" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "charge-smsbn"
	  codec => json
    }
  }
  if [fields][document_type] == "charge-csp" {
    elasticsearch {
      hosts => [ "https://172.19.43.100:9201" ]
      user => "elastic"
      password => "Agri@2022"
      ssl => true
      ssl_certificate_verification => false
      cacert => "/usr/share/logstash/certs/ca/ca.crt"
      index => "charge-csp"
	  codec => json
    }
  }
  stdout { codec => rubydebug }
}
